stages:
  - tf_apply
  - tf_destroy

variables:
  TF_VAR_AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
  TF_VAR_AWS_SECRET_KEY: ${AWS_SECRET_KEY}
  TF_STATE: "terraform/terraform.tfstate"

terraform_apply:
  stage: tf_apply
  tags:
    - test_job
    - wordpress
  script:
    - cd ./terraform
    - terraform init
    - terraform apply -auto-approve

  artifacts:
    paths:
      - ansible/hosts
      - ${TF_STATE}


terraform_destroy:
  stage: tf_destroy
  tags:
    - test_job
    - wordpress
  script:
    - cd ./terraform
    - terraform init
    - terraform show
    - terraform destroy -auto-approve
  # variables:
  #   TF_VAR_AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
  #   TF_VAR_AWS_SECRET_KEY: ${AWS_SECRET_KEY}
  when: manual
  dependencies: 
    - terraform_apply